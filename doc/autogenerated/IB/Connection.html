<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: IB::Connection

    &mdash; Documentation by YARD 0.7.3

</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>

    <div id="header">
      <div id="menu">

    <a href="../_index.html">Index (C)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../IB.html" title="IB (module)">IB</a></span></span>
     &raquo;
    <span class="title">Connection</span>


  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">

    <a id="class_list_link" href="#">Class List</a>

    <a id="method_list_link" href="#">Method List</a>

    <a id="file_list_link" href="#">File List</a>

</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: IB::Connection



</h1>

<dl class="box">

    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>

        <ul class="fullTree">
          <li>Object</li>

            <li class="next">IB::Connection</li>

        </ul>
        <a href="#" class="inheritanceTree">show all</a>

      </dd>









    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/ib-ruby/connection.rb</dd>

</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Encapsulates API connection to TWS or Gateway</p>


  </div>
</div>
<div class="tags">


</div>
  <h2>Constant Summary</h2>

    <dl class="constants">

        <dt id="CLIENT_VERSION-constant" class="">CLIENT_VERSION =
          <div class="docstring">
  <div class="discussion">
    <p>Please note, we are realizing only the most current TWS protocol versions,
thus improving performance at the expense of backwards compatibility.
Older protocol versions support can be found in older gem versions.</p>


  </div>
</div>
<div class="tags">


</div>
        </dt>
        <dd><pre class="code"><span class='int'>48</span></pre></dd>

        <dt id="SERVER_VERSION-constant" class="">SERVER_VERSION =
          <div class="docstring">
  <div class="discussion">
    <p>Was 27 in original Ruby code
Minimal server version. Latest, was 38 in current Java code.</p>


  </div>
</div>
<div class="tags">


</div>
        </dt>
        <dd><pre class="code"><span class='int'>53</span></pre></dd>

        <dt id="DEFAULT_OPTIONS-constant" class="">DEFAULT_OPTIONS =

        </dt>
        <dd><pre class="code"><span class='lbrace'>{</span><span class='symbol'>:host</span> <span class='op'>=&gt;</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>127.0.0.1</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                   <span class='symbol'>:port</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>4001</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='comment'># IB Gateway connection (default)
</span>                   <span class='comment'>#:port =&gt; '7496', # TWS connection, with annoying pop-ups
</span>                   <span class='symbol'>:connect</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
                   <span class='symbol'>:reader</span> <span class='op'>=&gt;</span> <span class='kw'>true</span>
<span class='rbrace'>}</span></pre></dd>

    </dl>



  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">

      <li class="public ">
  <span class="summary_signature">

      <a href="#next_order_id-instance_method" title="#next_order_id (instance method)">- (Object) <strong>next_order_id</strong> </a>



  </span>


    <span class="note title readonly">readonly</span>








    <span class="summary_desc"><div class='inline'><p>Info about IB server and server connection state.</p>
</div></span>

</li>


      <li class="public ">
  <span class="summary_signature">

      <a href="#server-instance_method" title="#server (instance method)">- (Object) <strong>server</strong> </a>



  </span>


    <span class="note title readonly">readonly</span>








    <span class="summary_desc"><div class='inline'><p>Info about IB server and server connection state.</p>
</div></span>

</li>


  </ul>





    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">

        <li class="public ">
  <span class="summary_signature">

      <a href="#connect-instance_method" title="#connect (instance method)">- (Object) <strong>connect</strong> </a>



      (also: #open)

  </span>








    <span class="summary_desc"><div class='inline'>
</div></span>

</li>


        <li class="public ">
  <span class="summary_signature">

      <a href="#connected%3F-instance_method" title="#connected? (instance method)">- (Boolean) <strong>connected?</strong> </a>



  </span>








    <span class="summary_desc"><div class='inline'>
</div></span>

</li>


        <li class="public ">
  <span class="summary_signature">

      <a href="#disconnect-instance_method" title="#disconnect (instance method)">- (Object) <strong>disconnect</strong> </a>



      (also: #close)

  </span>








    <span class="summary_desc"><div class='inline'>
</div></span>

</li>


        <li class="public ">
  <span class="summary_signature">

      <a href="#initialize-instance_method" title="#initialize (instance method)">- (Connection) <strong>initialize</strong>(opts = {}) </a>



  </span>

    <span class="note title constructor">constructor</span>








    <span class="summary_desc"><div class='inline'><p>A new instance of Connection.</p>
</div></span>

</li>


        <li class="public ">
  <span class="summary_signature">

      <a href="#process_message-instance_method" title="#process_message (instance method)">- (Object) <strong>process_message</strong> </a>



  </span>








    <span class="summary_desc"><div class='inline'><p>Process single incoming message (blocking).</p>
</div></span>

</li>


        <li class="public ">
  <span class="summary_signature">

      <a href="#process_messages-instance_method" title="#process_messages (instance method)">- (Object) <strong>process_messages</strong>(poll_time = 200) </a>



  </span>








    <span class="summary_desc"><div class='inline'><p>Process incoming messages during <em>poll_time</em> (200) msecs.</p>
</div></span>

</li>


        <li class="protected ">
  <span class="summary_signature">

      <a href="#random_id-instance_method" title="#random_id (instance method)">- (Object) <strong>random_id</strong> </a>



  </span>


  <span class="note title protected">protected</span>





    <span class="summary_desc"><div class='inline'>
</div></span>

</li>


        <li class="public ">
  <span class="summary_signature">

      <a href="#send_message-instance_method" title="#send_message (instance method)">- (Object) <strong>send_message</strong>(what, *args) </a>



      (also: #dispatch)

  </span>








    <span class="summary_desc"><div class='inline'><p>Send an outgoing message.</p>
</div></span>

</li>


        <li class="protected ">
  <span class="summary_signature">

      <a href="#start_reader-instance_method" title="#start_reader (instance method)">- (Object) <strong>start_reader</strong> </a>



  </span>


  <span class="note title protected">protected</span>





    <span class="summary_desc"><div class='inline'><p>Start reader thread that continuously reads messages from server in background.</p>
</div></span>

</li>


        <li class="public ">
  <span class="summary_signature">

      <a href="#subscribe-instance_method" title="#subscribe (instance method)">- (Object) <strong>subscribe</strong>(*args, &amp;block) </a>



  </span>








    <span class="summary_desc"><div class='inline'><p>Subscribe Proc or block to specific type(s) of incoming message events.</p>
</div></span>

</li>


        <li class="public ">
  <span class="summary_signature">

      <a href="#subscribers-instance_method" title="#subscribers (instance method)">- (Object) <strong>subscribers</strong> </a>



  </span>








    <span class="summary_desc"><div class='inline'><p>Message subscribers.</p>
</div></span>

</li>


        <li class="public ">
  <span class="summary_signature">

      <a href="#unsubscribe-instance_method" title="#unsubscribe (instance method)">- (Object) <strong>unsubscribe</strong>(subscriber_id) </a>



  </span>








    <span class="summary_desc"><div class='inline'><p>Remove all subscribers with specific subscriber id.</p>
</div></span>

</li>


    </ul>


<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>

    <div class="method_details first">
  <p class="signature first" id="initialize-instance_method">

    - (<tt><span class='object_link'><a href="" title="IB::Connection (class)">Connection</a></span></tt>) <strong>initialize</strong>(opts = {})



</p><div class="docstring">
  <div class="discussion">
    <p>A new instance of Connection</p>


  </div>
</div>
<div class="tags">


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


32
33
34
35
36
37
38
39
40
41</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 32</span>

<span class='kw'>def</span> <span class='id initialize'>initialize</span><span class='lparen'>(</span><span class='id opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='ivar'>@options</span> <span class='op'>=</span> <span class='const'>DEFAULT_OPTIONS</span><span class='period'>.</span><span class='id merge'>merge</span><span class='lparen'>(</span><span class='id opts'>opts</span><span class='rparen'>)</span>

  <span class='ivar'>@connected</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@next_order_id</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@server</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id new'>new</span>

  <span class='id connect'>connect</span> <span class='kw'>if</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:connect</span><span class='rbracket'>]</span>
  <span class='id start_reader'>start_reader</span> <span class='kw'>if</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:reader</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>

</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>


      <span id=""></span>
      <span id="next_order_id-instance_method"></span>
      <div class="method_details first">
  <p class="signature first" id="next_order_id-instance_method">

    - (<tt>Object</tt>) <strong>next_order_id</strong>  <span class="extras">(readonly)</span>



</p><div class="docstring">
  <div class="discussion">
    <p>Info about IB server and server connection state</p>


  </div>
</div>
<div class="tags">


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


29
30
31</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 29</span>

<span class='kw'>def</span> <span class='id next_order_id'>next_order_id</span>
  <span class='ivar'>@next_order_id</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>


      <span id=""></span>
      <span id="server-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="server-instance_method">

    - (<tt>Object</tt>) <strong>server</strong>  <span class="extras">(readonly)</span>



</p><div class="docstring">
  <div class="discussion">
    <p>Info about IB server and server connection state</p>


  </div>
</div>
<div class="tags">


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


29
30
31</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 29</span>

<span class='kw'>def</span> <span class='id server'>server</span>
  <span class='ivar'>@server</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>

  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>


      <div class="method_details first">
  <p class="signature first" id="connect-instance_method">

    - (<tt>Object</tt>) <strong>connect</strong>



    <span class="aliases">Also known as:
    <span class="names"><span id='open-instance_method'>open</span></span>
    </span>

</p><div class="docstring">
  <div class="discussion">



  </div>
</div>
<div class="tags">

<h3>Raises:</h3>
<ul class="raise">

    <li>


        <span class='type'>(<tt>Exception</tt>)</span>



    </li>

</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 51</span>

<span class='kw'>def</span> <span class='id connect'>connect</span>
  <span class='id raise'>raise</span> <span class='const'>Exception</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Already connected!</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@connected</span>

  <span class='comment'># TWS always sends NextValidId message at connect - save this id
</span>  <span class='kw'>self</span><span class='period'>.</span><span class='id subscribe'>subscribe</span><span class='lparen'>(</span><span class='symbol'>:NextValidId</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id msg'>msg</span><span class='op'>|</span>
    <span class='ivar'>@next_order_id</span> <span class='op'>=</span> <span class='id msg'>msg</span><span class='period'>.</span><span class='id data'>data</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span>
    <span class='id puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Got next valid order id: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@next_order_id</span><span class='rbrace'>}</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:socket</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>IBSocket</span><span class='period'>.</span><span class='id open'>open</span><span class='lparen'>(</span><span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:host</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:port</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='comment'># Secret handshake
</span>  <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:socket</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id send'>send</span><span class='lparen'>(</span><span class='const'>CLIENT_VERSION</span><span class='rparen'>)</span>
  <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:version</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:socket</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id read_int'>read_int</span>
  <span class='id raise'>raise</span><span class='lparen'>(</span><span class='const'>Exception</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TWS version &gt;= </span><span class='embexpr_beg'>#{</span><span class='const'>SERVER_VERSION</span><span class='rbrace'>}</span><span class='tstring_content'> required.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:version</span><span class='rbracket'>]</span> <span class='op'>&lt;</span> <span class='const'>SERVER_VERSION</span>

  <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:local_connect_time</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id now'>now</span><span class='lparen'>(</span><span class='rparen'>)</span>
  <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:remote_connect_time</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:socket</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id read_string'>read_string</span>

  <span class='comment'># Sending arbitrary client ID to identify subsequent communications.
</span>  <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:client_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id random_id'>random_id</span>
  <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:socket</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id send'>send</span><span class='lparen'>(</span><span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:client_id</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='ivar'>@connected</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Connected to server, version: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:version</span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'>, connection time: </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
           <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:local_connect_time</span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'> local, </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
           <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:remote_connect_time</span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'> remote.</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>

      <div class="method_details ">
  <p class="signature " id="connected?-instance_method">

    - (<tt>Boolean</tt>) <strong>connected?</strong>



</p><div class="docstring">
  <div class="discussion">



  </div>
</div>
<div class="tags">

<h3>Returns:</h3>
<ul class="return">

    <li>


        <span class='type'>(<tt>Boolean</tt>)</span>



    </li>

</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


94
95
96</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 94</span>

<span class='kw'>def</span> <span class='id connected?'>connected?</span>
  <span class='ivar'>@connected</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>

      <div class="method_details ">
  <p class="signature " id="disconnect-instance_method">

    - (<tt>Object</tt>) <strong>disconnect</strong>



    <span class="aliases">Also known as:
    <span class="names"><span id='close-instance_method'>close</span></span>
    </span>

</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


82
83
84
85
86
87
88
89
90</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 82</span>

<span class='kw'>def</span> <span class='id disconnect'>disconnect</span>
  <span class='kw'>if</span> <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:reader</span><span class='rbracket'>]</span>
    <span class='ivar'>@reader_running</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:reader</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id join'>join</span>
  <span class='kw'>end</span>
  <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:socket</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id close'>close</span>
  <span class='ivar'>@server</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id new'>new</span>
  <span class='ivar'>@connected</span> <span class='op'>=</span> <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>

      <div class="method_details ">
  <p class="signature " id="process_message-instance_method">

    - (<tt>Object</tt>) <strong>process_message</strong>



</p><div class="docstring">
  <div class="discussion">
    <p>Process single incoming message (blocking)</p>


  </div>
</div>
<div class="tags">


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 159</span>

<span class='kw'>def</span> <span class='id process_message'>process_message</span>
  <span class='comment'># This read blocks!
</span>  <span class='id msg_id'>msg_id</span> <span class='op'>=</span> <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:socket</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id read_int'>read_int</span>

  <span class='comment'># Debug:
</span>  <span class='kw'>unless</span> <span class='lbracket'>[</span><span class='int'>1</span><span class='comma'>,</span> <span class='int'>2</span><span class='comma'>,</span> <span class='int'>4</span><span class='comma'>,</span> <span class='int'>6</span><span class='comma'>,</span> <span class='int'>7</span><span class='comma'>,</span> <span class='int'>8</span><span class='comma'>,</span> <span class='int'>9</span><span class='comma'>,</span> <span class='int'>12</span><span class='comma'>,</span> <span class='int'>21</span><span class='comma'>,</span> <span class='int'>53</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id include?'>include?</span> <span class='id msg_id'>msg_id</span>
    <span class='id puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Got message </span><span class='embexpr_beg'>#{</span><span class='id msg_id'>msg_id</span><span class='rbrace'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='const'>Messages</span><span class='op'>::</span><span class='const'>Incoming</span><span class='op'>::</span><span class='const'>Table</span><span class='lbracket'>[</span><span class='id msg_id'>msg_id</span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Create new instance of the appropriate message type, and have it read the message.
</span>  <span class='comment'># NB: Failure here usually means unsupported message type received
</span>  <span class='id msg'>msg</span> <span class='op'>=</span> <span class='const'>Messages</span><span class='op'>::</span><span class='const'>Incoming</span><span class='op'>::</span><span class='const'>Table</span><span class='lbracket'>[</span><span class='id msg_id'>msg_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:socket</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='id subscribers'>subscribers</span><span class='lbracket'>[</span><span class='id msg'>msg</span><span class='period'>.</span><span class='id class'>class</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id _'>_</span><span class='comma'>,</span> <span class='id subscriber'>subscriber</span><span class='op'>|</span> <span class='id subscriber'>subscriber</span><span class='period'>.</span><span class='id call'>call</span><span class='lparen'>(</span><span class='id msg'>msg</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='id puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No subscribers for message </span><span class='embexpr_beg'>#{</span><span class='id msg'>msg</span><span class='period'>.</span><span class='id class'>class</span><span class='rbrace'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id subscribers'>subscribers</span><span class='lbracket'>[</span><span class='id msg'>msg</span><span class='period'>.</span><span class='id class'>class</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id empty?'>empty?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>

      <div class="method_details ">
  <p class="signature " id="process_messages-instance_method">

    - (<tt>Object</tt>) <strong>process_messages</strong>(poll_time = 200)



</p><div class="docstring">
  <div class="discussion">
    <p>Process incoming messages during <em>poll_time</em> (200) msecs</p>


  </div>
</div>
<div class="tags">


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


150
151
152
153
154
155
156</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 150</span>

<span class='kw'>def</span> <span class='id process_messages'>process_messages</span> <span class='id poll_time'>poll_time</span> <span class='op'>=</span> <span class='int'>200</span> <span class='comment'># in msec
</span>  <span class='id time_out'>time_out</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id now'>now</span> <span class='op'>+</span> <span class='id poll_time'>poll_time</span><span class='op'>/</span><span class='float'>1000.0</span>
  <span class='kw'>while</span> <span class='lparen'>(</span><span class='id time_left'>time_left</span> <span class='op'>=</span> <span class='id time_out'>time_out</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id now'>now</span><span class='rparen'>)</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='comment'># If server socket is readable, process single incoming message
</span>    <span class='id process_message'>process_message</span> <span class='kw'>if</span> <span class='id select'>select</span> <span class='lbracket'>[</span><span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:socket</span><span class='rbracket'>]</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id time_left'>time_left</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>

      <div class="method_details ">
  <p class="signature " id="random_id-instance_method">

    - (<tt>Object</tt>) <strong>random_id</strong>  <span class="extras">(protected)</span>



</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


178
179
180</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 178</span>

<span class='kw'>def</span> <span class='id random_id'>random_id</span>
  <span class='id rand'>rand</span> <span class='int'>999999999</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>

      <div class="method_details ">
  <p class="signature " id="send_message-instance_method">

    - (<tt>Object</tt>) <strong>send_message</strong>(what, *args)



    <span class="aliases">Also known as:
    <span class="names"><span id='dispatch-instance_method'>dispatch</span></span>
    </span>

</p><div class="docstring">
  <div class="discussion">
    <p>Send an outgoing message.</p>


  </div>
</div>
<div class="tags">


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


132
133
134
135
136
137
138
139
140
141
142
143
144
145</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 132</span>

<span class='kw'>def</span> <span class='id send_message'>send_message</span><span class='lparen'>(</span><span class='id what'>what</span><span class='comma'>,</span> <span class='op'>*</span><span class='id args'>args</span><span class='rparen'>)</span>
  <span class='id message'>message</span> <span class='op'>=</span>
      <span class='kw'>case</span>
        <span class='kw'>when</span> <span class='id what'>what</span><span class='period'>.</span><span class='id is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Messages</span><span class='op'>::</span><span class='const'>Outgoing</span><span class='op'>::</span><span class='const'>AbstractMessage</span><span class='rparen'>)</span>
          <span class='id what'>what</span>
        <span class='kw'>when</span> <span class='id what'>what</span><span class='period'>.</span><span class='id is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Class</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id what'>what</span> <span class='op'>&lt;</span> <span class='const'>Messages</span><span class='op'>::</span><span class='const'>Outgoing</span><span class='op'>::</span><span class='const'>AbstractMessage</span>
          <span class='id what'>what</span><span class='period'>.</span><span class='id new'>new</span> <span class='op'>*</span><span class='id args'>args</span>
        <span class='kw'>when</span> <span class='id what'>what</span><span class='period'>.</span><span class='id is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Symbol</span><span class='rparen'>)</span>
          <span class='const'>Messages</span><span class='op'>::</span><span class='const'>Outgoing</span><span class='period'>.</span><span class='id const_get'>const_get</span><span class='lparen'>(</span><span class='id what'>what</span><span class='rparen'>)</span><span class='period'>.</span><span class='id new'>new</span> <span class='op'>*</span><span class='id args'>args</span>
        <span class='kw'>else</span>
          <span class='id raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Only able to send outgoing IB messages</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
  <span class='id message'>message</span><span class='period'>.</span><span class='id send_to'>send_to</span><span class='lparen'>(</span><span class='ivar'>@server</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>

      <div class="method_details ">
  <p class="signature " id="start_reader-instance_method">

    - (<tt>Object</tt>) <strong>start_reader</strong>  <span class="extras">(protected)</span>



</p><div class="docstring">
  <div class="discussion">
    <p>Start reader thread that continuously reads messages from server in background.
If you don't start reader, you should manually poll @server[:socket] for messages
or use #process_messages(msec) API.</p>


  </div>
</div>
<div class="tags">


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


185
186
187
188
189
190
191</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 185</span>

<span class='kw'>def</span> <span class='id start_reader'>start_reader</span>
  <span class='const'>Thread</span><span class='period'>.</span><span class='id abort_on_exception'>abort_on_exception</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='ivar'>@reader_running</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='ivar'>@server</span><span class='lbracket'>[</span><span class='symbol'>:reader</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id new'>new</span> <span class='kw'>do</span>
    <span class='id process_messages'>process_messages</span> <span class='kw'>while</span> <span class='ivar'>@reader_running</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>

      <div class="method_details ">
  <p class="signature " id="subscribe-instance_method">

    - (<tt>Object</tt>) <strong>subscribe</strong>(*args, &amp;block)



</p><div class="docstring">
  <div class="discussion">
    <p>Subscribe Proc or block to specific type(s) of incoming message events.
Listener will be called later with received message instance as its argument.
Returns subscriber id to allow unsubscribing</p>


  </div>
</div>
<div class="tags">


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 101</span>

<span class='kw'>def</span> <span class='id subscribe'>subscribe</span><span class='lparen'>(</span><span class='op'>*</span><span class='id args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id block'>block</span><span class='rparen'>)</span>
  <span class='id subscriber'>subscriber</span> <span class='op'>=</span> <span class='id args'>args</span><span class='period'>.</span><span class='id last'>last</span><span class='period'>.</span><span class='id respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:call</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id args'>args</span><span class='period'>.</span><span class='id pop'>pop</span> <span class='op'>:</span> <span class='id block'>block</span>
  <span class='id subscriber_id'>subscriber_id</span> <span class='op'>=</span> <span class='id random_id'>random_id</span>

  <span class='id raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Need subscriber proc or block</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id subscriber'>subscriber</span><span class='period'>.</span><span class='id is_a?'>is_a?</span> <span class='const'>Proc</span>

  <span class='id args'>args</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id what'>what</span><span class='op'>|</span>
    <span class='id message_class'>message_class</span> <span class='op'>=</span>
        <span class='kw'>case</span>
          <span class='kw'>when</span> <span class='id what'>what</span><span class='period'>.</span><span class='id is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Class</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id what'>what</span> <span class='op'>&lt;</span> <span class='const'>Messages</span><span class='op'>::</span><span class='const'>Incoming</span><span class='op'>::</span><span class='const'>AbstractMessage</span>
            <span class='id what'>what</span>
          <span class='kw'>when</span> <span class='id what'>what</span><span class='period'>.</span><span class='id is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Symbol</span><span class='rparen'>)</span>
            <span class='const'>Messages</span><span class='op'>::</span><span class='const'>Incoming</span><span class='period'>.</span><span class='id const_get'>const_get</span><span class='lparen'>(</span><span class='id what'>what</span><span class='rparen'>)</span>
          <span class='kw'>else</span>
            <span class='id raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id what'>what</span><span class='rbrace'>}</span><span class='tstring_content'> must represent incoming IB message class</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>

    <span class='id subscribers'>subscribers</span><span class='lbracket'>[</span><span class='id message_class'>message_class</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id subscriber_id'>subscriber_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id subscriber'>subscriber</span>
  <span class='kw'>end</span>
  <span class='id subscriber_id'>subscriber_id</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>

      <div class="method_details ">
  <p class="signature " id="subscribers-instance_method">

    - (<tt>Object</tt>) <strong>subscribers</strong>



</p><div class="docstring">
  <div class="discussion">
    <p>Message subscribers. Key is the message class to listen for.
Value is a Hash of subscriber Procs, keyed by their subscription id.
All subscriber Procs will be called with the message instance
as an argument when a message of that type is received.</p>


  </div>
</div>
<div class="tags">


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


47
48
49</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 47</span>

<span class='kw'>def</span> <span class='id subscribers'>subscribers</span>
  <span class='ivar'>@subscribers</span> <span class='op'>||=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id new'>new</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id hash'>hash</span><span class='comma'>,</span> <span class='id key'>key</span><span class='op'>|</span> <span class='id hash'>hash</span><span class='lbracket'>[</span><span class='id key'>key</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id new'>new</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>

      <div class="method_details ">
  <p class="signature " id="unsubscribe-instance_method">

    - (<tt>Object</tt>) <strong>unsubscribe</strong>(subscriber_id)



</p><div class="docstring">
  <div class="discussion">
    <p>Remove all subscribers with specific subscriber id</p>


  </div>
</div>
<div class="tags">


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


124
125
126
127
128
129</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/ib-ruby/connection.rb', line 124</span>

<span class='kw'>def</span> <span class='id unsubscribe'>unsubscribe</span><span class='lparen'>(</span><span class='id subscriber_id'>subscriber_id</span><span class='rparen'>)</span>

  <span class='id subscribers'>subscribers</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id message_class'>message_class</span><span class='comma'>,</span> <span class='id message_subscribers'>message_subscribers</span><span class='op'>|</span>
    <span class='id message_subscribers'>message_subscribers</span><span class='period'>.</span><span class='id delete'>delete</span> <span class='id subscriber_id'>subscriber_id</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>

  </div>

</div>

    <div id="footer">
  Generated on Tue Nov 22 01:30:22 2011 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.3 (ruby-1.9.2).
</div>

  </body>
</html>
